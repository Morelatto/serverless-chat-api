@startuml component-dependencies-clean

title Chat API Internal Component Dependencies

skinparam packageStyle rectangle
skinparam componentStyle rectangle
skinparam backgroundColor #FEFEFE
skinparam ArrowThickness 1.5
skinparam ArrowColor #4A90E2
skinparam roundcorner 10
skinparam shadowing false
skinparam linetype ortho

' Legend
legend top right
|= Arrow Type |= Meaning |
| ——> | Direct import |
| - -> | Protocol implementation |
| ..> | Type-only import |
endlegend

' Layout - Top to Bottom with manual positioning
!define XPOS_ENTRY 50
!define XPOS_API 250
!define XPOS_SERVICE 500
!define XPOS_PROVIDER 750
!define XPOS_STORAGE 750
!define XPOS_SHARED 1000

package "Entry Points" #E0E0E0 {
    [__main__.py] #E0E0E0
    [aws.py] #E0E0E0
}

package "API Layer" #FFE6E6 {
    [api.py] #FFE6E6
    [middleware.py] #FFE6E6
}

package "Service Layer" #E6F3FF {
    [chat.py] #E6F3FF
}

package "Infrastructure" #F0F0F0 {
    package "Providers" #E6FFE6 {
        [providers.py] #E6FFE6
        [retry.py] #E6FFE6
    }

    package "Storage" #FFE6F9 {
        [storage.py] #FFE6F9
    }
}

package "Shared" #FFF9E6 {
    [config.py] #FFF9E6
    [exceptions.py] #FFF9E6
    [types.py] #FFF9E6
}

' Entry point dependencies
[__main__.py] --> [api.py] : app
[__main__.py] --> [config.py] : settings
[aws.py] --> [api.py] : app

' API Layer dependencies
[api.py] --> [chat.py] : ChatService
[api.py] --> [config.py] : settings
[api.py] --> [exceptions.py] : errors
[api.py] --> [middleware.py] : add_request_id
[api.py] --> [providers.py] : create_llm_provider
[api.py] --> [storage.py] : create_repository,\ncreate_cache
[api.py] ..> [types.py] : MessageRecord

' Service Layer dependencies
[chat.py] --> [exceptions.py] : errors
[chat.py] ..> [providers.py] : LLMProvider
[chat.py] ..> [storage.py] : Repository,\nCache
[chat.py] ..> [types.py] : types

' Provider dependencies
[providers.py] --> [exceptions.py] : ConfigurationError
[providers.py] --> [retry.py] : with_llm_retry
[providers.py] ..> [types.py] : TokenUsage
[retry.py] --> [exceptions.py] : LLMProviderError

' Storage dependencies
[storage.py] --> [exceptions.py] : StorageError
[storage.py] ..> [types.py] : MessageRecord

note bottom of chat.py
  Dependency Injection:
  ChatService receives implementations
  of protocols at runtime
end note

note top of api.py
  Entry point for FastAPI
  Wires up all dependencies
end note

@enduml
